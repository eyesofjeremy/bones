// Pure CSS Parallax, only if the browser supports it.
@media screen and ( min-width: $page_m ) {
  @supports ( (perspective: 1px) and (not (-webkit-overflow-scrolling: touch) ) ) {

    // See http://keithclark.co.uk/articles/practical-css-parallax/ for more on why do this
    %parallax__body {
      transform: translateZ(0);
      overflow-y: hidden;
    }

    %parallax {
      overflow-x: hidden;
      overflow-y: auto;
      height: 100vh;
      perspective: 800px;
    }
  
    @mixin parallax__group( $howhigh: 100vh ) {
      position: relative;
      height: $howhigh;
      transform-style: preserve-3d;
    }

    %parallax__layer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    %not__parallax {
      position: relative;
      z-index: 4;
    }
    
    %parallax_ancestors {
      transform-style: preserve-3d;
    }

    %parallax__layer_back {
      @extend %parallax__layer;
      transform: translateZ(-250px) scale(1.32);
    }

    %parallax__layer_back_2 {
      @extend %parallax__layer;
      transform: translateZ(-250px) translateX(-125px) scale(1.32);
    }

    %parallax__layer_front {
      @extend %parallax__layer;
      transform: translateZ(100px) scale(.9);
    }

    %parallax__layer_base {
      @extend %parallax__layer;
      transform: translateZ(0);
    }

    html { // add class for testing!

      body {
        @extend %parallax__body;
      }

      .site {
        @extend %parallax;
      }
      
      .header, .entry-content {
        @extend %not__parallax;
      }
      
      .entry-content {
        background: white;
      }
      
      .site, #content, #inner-content, #main, .has-post-thumbnail {
        @extend %parallax_ancestors;
      }

      .has-post-thumbnail {
        .article-header {
          @include parallax__group( 35vw );
        }
      }
      
      .featured {    
        @extend %parallax__layer_back;
        top: -60px;
      }
      
      /*
        Seeing issues where we can't have a parallax element as a
        sibling of an element using mix-blend-mode: multiply. Very frustrating.
        Could rework HTML to accommodate but it seems more than a little janky,
        since it's pretty semantic now.
      */
            
      // Can target Firefox here, but we are currently skipping entirely.
      @-moz-document url-prefix() {
        .site, .site-content, .content-area, .site-main {
          position: relative;
          transform-style: preserve-3d;
        }
      }
  
      .has-post-thumbnail {
        .page-title {    

          &:after {
            content: '';
            position: absolute;
            top: 100%;
            height: 7em;
            left: 0;
            right: 0;
            background: white;
          }
        }
    
        .entry-content {
          position: relative;
        }
      }
    }
    
    #wpadminbar {
      top: -32px;
    }
  }

}